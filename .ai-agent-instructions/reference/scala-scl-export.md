# Scala .scl File Export Guide

**Purpose**: How to create Scala scale (.scl) files from DiArMaqAr tuning data.

---

## Table of Contents

- [Section A: Simple .scl Export (Tuning System)](#section-a-simple-scl-export-tuning-system)
- [Section B: 12-Pitch-Class Set .scl Export](#section-b-12-pitch-class-set-scl-export)
- [.scl File Format Specification](#scl-file-format-specification)
- [Common Issues and Solutions](#common-issues-and-solutions)

---

## Section A: Simple .scl Export (Maqām/Jins or Tuning System)

### When to Use

Export a maqām, jins, or tuning system's pitch classes as-is, without keyboard mapping or 12-pitch-class modifications.

**Use Cases**:
- Export specific maqām or jins for analysis or performance
- Reference documentation of a historical tuning system
- Import tuning into Scala software for analysis
- Academic research and comparison

### What Gets Exported

**For Maqām/Jins**:
- All pitch classes from the maqām/jins
- **Cents values relative to tonic** (tonic = 0 cents = 1/1 ratio, implicit)
- Excludes the tonic (0 cents is implicit in Scala format)

**For Tuning System**:
- All pitch classes from the tuning system
- Cents values relative to starting note (0 cents = 1/1 ratio)
- Octave (1200 cents = 2/1 ratio) as the last entry

**CRITICAL**: Simple maqām/jins exports now use **relative cents from the tonic**, not absolute cents from the tuning system reference. This ensures proper Scala format compliance.

### Algorithm for Maqām/Jins Export

#### Step 1: Get Maqām/Jins Pitch Classes

```typescript
const maqam = maqamData.getTahlil(fullRangeTuningSystemPitchClasses);
const pitchClasses = useAscending ? maqam.ascendingPitchClasses : maqam.descendingPitchClasses;
```

#### Step 2: Calculate Relative Cents from Tonic

```typescript
// Get tonic (first pitch class) cents value
const tonicCents = pitchClasses.length > 0 ? parseFloat(pitchClasses[0].cents) : 0;

// Calculate relative cents for all pitch classes
const scaleNotes = uniquePitchClasses
  .map(pc => ({
    pitchClass: pc,
    relativeCents: parseFloat(pc.cents) - tonicCents
  }))
  .filter(item => Math.abs(item.relativeCents) > 0.01); // Exclude tonic (0 cents)
```

**Important**:
- Tonic cents are subtracted from all pitch classes
- Tonic (0 cents relative) is filtered out as it's implicit in Scala format
- Use `> 0.01` threshold to handle floating point precision

#### Step 3: Build Header and Export

```typescript
const headerLines = buildScalaHeader(desc, {
  direction: useAscending ? "Ascending" : "Descending",
  rootNote: pitchClasses[0]?.noteName,
  tuningSystem: tuningSystem.getTitleEnglish(),
});

const lines = [
  ...headerLines,
  `${desc}`,
  `${scaleNotes.length}`,
  `!`,
  ...scaleNotes.map(item => item.relativeCents.toFixed(2)),
];
```

### Example Output (Maqām Bayyāt)

```
! maqām bayyāt (Ascending) - 7-Fret Oud 17-Tone (Ibn Sīnā, 1037)
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Root note: dūgāh
! Direction: Ascending
! Source tuning system: 7-Fret Oud 17-Tone
!
maqām bayyāt (Ascending) - 7-Fret Oud 17-Tone (Ibn Sīnā, 1037)
6
!
138.57
294.13
498.04
702.00
840.57
996.13
```

**Note**: 6 entries because the tonic (0 cents) is implicit and excluded.

---

### Algorithm for Tuning System Export

#### Step 1: Get Tuning System Pitch Classes

```typescript
const tuningSystem = await TuningSystem.getById(tuningSystemId);
const pitchClasses = getTuningSystemPitchClasses(tuningSystem, startingNote);
```

#### Step 2: Build Header

```typescript
const header = `! ${tuningSystem.stringify()}
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Starting note: ${startingNoteName} (${startingNoteIPN}${startingNoteOctave})
! Starting note frequency: ${startingNoteFrequency} Hz
!
${tuningSystem.getName()} (starting note: ${startingNoteName})
${pitchClasses.length}
!`;
```

**Header Components**:
1. First line: Tuning system description
2. Comment lines starting with `!` for metadata
3. Non-comment line: Tuning system name (displayed in Scala software)
4. Number of entries (excluding implicit 0 cents root)
5. Optional separator comment

#### Step 3: Add Pitch Class Cents Values

```typescript
const entries: string[] = [];

for (let i = 1; i < pitchClasses.length; i++) {
  const pc = pitchClasses[i];
  const cents = parseFloat(pc.cents);
  const centsInOctave = cents % 1200; // Normalize to one octave
  entries.push(centsInOctave.toFixed(2));
}
```

**Important**:
- **Skip the first pitch class** (0 cents / 1/1 ratio is implicit in .scl format)
- **Normalize to one octave**: Use modulo 1200 to get cents within one octave
- **Include octave**: Add 1200.00 as the last entry

#### Step 4: Add Octave and Finalize

```typescript
entries.push('1200.00'); // Octave (2/1 ratio)

const sclContent = header + '\n' + entries.join('\n');
```

### Example Output

```
! al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Starting note: yegāh (G2)
! Starting note frequency: 97.998 Hz
!
al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone
27
!
90.22
98.95
182.40
203.91
294.13
...
1109.78
1200.00
```

### File Naming

```
{tuningSystemId}_{startingNote}_octave1.scl
```

**Example**: `al-Farabi-(950g)_yegah_octave1.scl`

---

## Section B: 12-Pitch-Class Set .scl Export

### When to Use

Export a maqām's 12-pitch-class set for full chromatic MIDI keyboard mapping.

**Use Cases**:
- MIDI keyboard composition with chromatic note access
- DAW integration for microtonal music production
- Full chromatic transposition capability

### What Gets Exported

- 12 chromatic pitch classes (C, C#, D, D#, E, F, F#, G, G#, A, A#, B)
- Maqām pitch classes + tuning system fillers
- Starting from C (IPN reference), not from maqām tonic
- Suitable for direct .scl import without .kbm file

### Prerequisites

Get the 12-pitch-class set from the API or function:

```typescript
// Option 1: Use API
const response = await fetch(
  `/api/maqamat/classification/12-pitch-class-sets?setId=maqam_rast_set&startSetFromC=true&pitchClassDataType=cents`
);
const data = await response.json();
const pitchClasses = data.sets[0].pitchClassSet.pitchClasses;

// Option 2: Use function directly
const pitchClassSet = create12PitchClassSet(
  maqamTransposition,
  alKindiTuningSystem,
  alKindiStartingNote
);
// Then rotate to start from C (see 12-pitch-class-sets-api.md)
```

**Important**: Always use `startSetFromC=true` when calling the API to get pitch classes starting from C.

### Algorithm

#### Step 1: Get 12-Pitch-Class Set Starting from C

The pitch classes must already be:
- ✅ Rotated to start from C (not maqām tonic)
- ✅ In chromatic ascending order (C, C#, D, ..., B)
- ✅ With octave-shifted values for notes before tonic

**Do NOT re-sort or re-order** - the API/function already provides correct ordering.

#### Step 2: Build Comprehensive Header

```typescript
const header = `! ${maqamName} (12 pitch class chromatic set)
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr) ${currentUrl || ''}
! Source maqām: ${maqamName}
! Source maqām tonic note name: ${tonicNoteName}
! Source tuning system: ${tuningSystemDescription}
! Scala file 1/1 (0 cents) reference frequency: ${cReferenceFrequency} Hz (C${cOctave})
! More information: ${currentUrl || ''}
!
! Compatible maqāmāt in this set (${compatibleCount} total):
! - ${compatibleMaqam1} (tonic: ${tonic1}, position ${pos1})
! - ${compatibleMaqam2} (tonic: ${tonic2}, position ${pos2})
! ...
${maqamName} - 12-tone chromatic set (${tuningSystemName})
12
!`;
```

**Header Rules**:
- **Capitalization**: Sentence case for labels. Lowercase for maqām names and note names.
  - ✅ "Source maqām:" (not "Source Maqām:")
  - ✅ "Compatible maqāmāt" (not "Compatible Maqāmāt")
- **Starting Note Name**: Get from `tuningSystem.getNoteNameSets()` using `standardizeText()` comparison
- **Reference Frequency Label**: "Scala file 1/1 (0 cents) reference frequency:" (clarifies this is for the 1/1 ratio)

#### Step 3: Extract Relative Cents from C

```typescript
const entries: string[] = [];

// First pitch class (C) is at 0 cents (implicit 1/1 ratio)
const referenceCents = parseFloat(pitchClasses[0].cents);

// Add remaining 11 pitch classes
for (let i = 1; i < pitchClasses.length; i++) {
  const pc = pitchClasses[i];
  const cents = parseFloat(pc.cents);
  let relativeCents = cents - referenceCents;

  // Handle wrap-around (should not occur if API used correctly)
  if (relativeCents < 0) {
    relativeCents += 1200;
  }

  entries.push(relativeCents.toFixed(2));
}
```

**Important**:
- First pitch class (C) is at 0 cents relative (implicit 1/1 ratio)
- All other pitch classes are relative to C
- Octave (1200.00) should be the last entry

#### Step 4: Add Octave and Finalize

```typescript
entries.push('1200.00'); // Octave (2/1 ratio)

const sclContent = header + '\n' + entries.join('\n');
```

### Example Output

```
! maqām rāst (12 pitch class chromatic set)
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr) https://diarmaqar.netlify.app
! Source maqām: maqām rāst
! Tuning system: al-Fārābī (950g) + al-Kindī (874)
! Tuning system starting note: ʿushayrān (A2)
! Tuning system starting note reference frequency: 110.00 Hz
! Scala file 1/1 (0 cents) reference frequency: 130.37 Hz (C3/rāst)
! Source maqām (maqām rāst) reference frequency: C3/rāst = 130.37 Hz
! A4 reference frequency: A4/jawāb ʿushayrān = 440.00 Hz
! maqām rāst tonic and frequency: C3/rāst = 130.37 Hz
! More information: https://diarmaqar.netlify.app/maqam/rast
!
! Compatible maqāmāt in this set: 49 unique / 159 inc. transpositions:
! - maqām rāst (and its transpositions: maqām rāst al-qarār rāst (C2), maqām rāst al-kurdān (C4))
!   Tonic: C (rāst), position 0
!   Ascending sequence: rāst (C3) → dūgāh (D3) → segāh (E-b3) → chahārgāh (F3) → nawā (G3) → ḥusaynī (A3) → ʿajam (Bb3)
!   Ascending positions: 0 → 2 → 4 → 5 → 7 → 9 → 11
!   Descending sequence: ʿajam (Bb3) → ḥusaynī (A3) → nawā (G3) → chahārgāh (F3) → segāh (E-b3) → dūgāh (D3) → rāst (C3)
!   Descending positions: 10 → 9 → 7 → 5 → 4 → 2 → 0
! - maqām bayyāt (and its transpositions: maqām bayyāt al-qarār dūgāh (D2), maqām bayyāt al-muhayyar (D4))
!   Tonic: D (dūgāh), position 2
!   Sequence: dūgāh (D3) → segāh (E-b3) → chahārgāh (F3) → nawā (G3) → ḥusaynī (A3) → ʿajam (Bb3) → tīk ḥiṣār (C4)
!   Positions: 0 → 2 → 3 → 5 → 7 → 8 → 10
! ...
maqām rāst - 12-tone chromatic set (al-Fārābī (950g) + al-Kindī (874))
12
!
113.69
203.91
294.13
348.73
498.04
611.73
701.96
800.91
905.87
996.09
1109.78
1200.00
```

**Recent Improvements (Dec 2024)**:
- ✅ **A4 Reference Frequency**: Now correctly finds natural A4 (~440 Hz) instead of microtonal variants
- ✅ **Dual Count Display**: Shows both unique maqamat count and total including transpositions
- ✅ **Tahlil-First Ordering**: Tahlil versions listed before transpositions for clarity
- ✅ **Sequence Labels**: Simplified to "Ascending sequence" and "Descending sequence" (removed "IPN")
- ✅ **Reference Frequency Lines**: Added three detailed frequency reference lines for source maqām, A4, and exported maqām

### File Naming

```
{maqamName}_12-tone-chromatic-set_{tuningSystemId}.scl
```

**Example**: `maqam_bayyat_shuri_12-tone-chromatic-set_al-Kindi-(874).scl`

### Function Reference

**`exportMaqamTo12ToneScala()`** in `src/functions/scala-export.ts` (lines 632-1080):

```typescript
export function exportMaqamTo12ToneScala(
  maqamInput: Maqam | MaqamData,
  tuningSystem: TuningSystem,
  startingNote: string,
  alKindiTuningSystem: TuningSystem,
  alKindiStartingNote: string,
  description?: string,
  currentUrl?: string
): string | null
```

**Returns**:
- `.scl` file content as string
- `null` if maqām is not a source for any 12-pitch-class set

---

## .scl File Format Specification

### Structure

```
! Comment line (optional, can have multiple)
Description line (displayed in Scala)
Number of notes
!
cents_value_1
cents_value_2
...
cents_value_N (should be 1200.00 for octave)
```

### Critical Rules

#### 1. Root Note is Implicit
The root note (0 cents / 1/1 ratio) is **NOT included** in the file.

**Correct**: Start with the second pitch class
**Incorrect**: Include 0.00 as first entry

#### 2. Octave Must Be Included
The octave (1200.00 cents / 2/1 ratio) **MUST** be the last entry.

**Correct**: Last line is `1200.00`
**Incorrect**: Last line is the highest note below 1200 cents

#### 3. Entry Count Excludes Root
The number on line 2 (after description) is the count of entries, excluding the implicit root.

**Example**:
```
27-tone tuning
27          ← 27 entries in file (root not counted)
!
90.22       ← Entry 1
...
1200.00     ← Entry 27 (octave)
```

#### 4. Comments Start with !
All comment lines must start with `!` character.

```
! This is a comment
This is not a comment (will be interpreted as description line)
```

#### 5. Cents or Ratios
Pitch values can be expressed as:
- **Cents**: Decimal number (e.g., `203.91`)
- **Ratio**: Fraction (e.g., `9/8`) or decimal ratio (e.g., `1.125`)

DiArMaqAr uses **cents** for consistency and precision.

---

## Common Issues and Solutions

### Issue 1: Wrong Entry Count

**Problem**: Entry count doesn't match number of lines.

**Solution**:
- Count all pitch classes excluding the implicit root (0 cents)
- Include the octave (1200.00) in the count

```typescript
// Correct
const entryCount = pitchClasses.length - 1 + 1; // -1 for root, +1 for octave
// Or simply:
const entryCount = pitchClasses.length;
```

### Issue 2: Missing Octave

**Problem**: Last entry is not 1200.00 cents.

**Solution**: Always add 1200.00 as the final entry.

```typescript
entries.push('1200.00');
```

### Issue 3: Including Root (0 cents)

**Problem**: First entry is 0.00 cents.

**Solution**: Skip the first pitch class (it's implicit).

```typescript
// Correct
for (let i = 1; i < pitchClasses.length; i++) { // Start from index 1

// Incorrect
for (let i = 0; i < pitchClasses.length; i++) { // Includes index 0
```

### Issue 4: Cents Not Normalized to Octave

**Problem**: Cents values exceed 1200 (before octave entry).

**Solution**: Use modulo 1200 to normalize to one octave (for simple tuning system exports).

```typescript
const centsInOctave = cents % 1200;
```

**Note**: For 12-pitch-class sets, do NOT normalize - the API already provides correct values.

### Issue 5: Wrong Starting Note Name

**Problem**: Starting note name is numeric index or incorrect format.

**Solution**: Get starting note name from tuning system's note name sets.

```typescript
// Correct pattern (from API route.ts lines 293-311)
const noteNameSets = tuningSystem.getNoteNameSets();
const matchingSet = noteNameSets.find(set =>
  standardizeText(set[0]) === standardizeText(startingNote)
);
const startingNoteName = matchingSet ? matchingSet[0] : startingNote;

// Incorrect
const startingNoteName = `note_${index}`; // Don't use indices
```

---

## Related Documentation

- [scala-export-overview.md](./scala-export-overview.md) - Choose export type
- [scala-kbm-export.md](./scala-kbm-export.md) - Keyboard mapping files
- [12-pitch-class-sets-api.md](./12-pitch-class-sets-api.md) - API for 12-pitch-class sets
- [12-pitch-class-sets-algorithm.md](./12-pitch-class-sets-algorithm.md) - Algorithm details

## External Resources

- [Official Scala .scl Format Specification](https://www.huygens-fokker.org/scala/scl_format.html)

---

*Complete guide for creating Scala .scl files from DiArMaqAr tuning data*
