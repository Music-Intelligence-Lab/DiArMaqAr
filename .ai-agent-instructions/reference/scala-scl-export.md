# Scala .scl File Export Guide

**Purpose**: How to create Scala scale (.scl) files from DiArMaqAr tuning data.

---

## Table of Contents

- [Section A: Simple .scl Export (Tuning System)](#section-a-simple-scl-export-tuning-system)
- [Section B: 12-Pitch-Class Set .scl Export](#section-b-12-pitch-class-set-scl-export)
- [.scl File Format Specification](#scl-file-format-specification)
- [Common Issues and Solutions](#common-issues-and-solutions)

---

## Section A: Simple .scl Export (Maqām/Jins or Tuning System)

### When to Use

Export a maqām, jins, or tuning system's pitch classes as-is, without keyboard mapping or 12-pitch-class modifications.

**Use Cases**:
- Export specific maqām or jins for analysis or performance
- Reference documentation of a historical tuning system
- Import tuning into Scala software for analysis
- Academic research and comparison

### What Gets Exported

**For Maqām/Jins**:
- All pitch classes from the maqām/jins
- **Cents values relative to tonic** (tonic = 0 cents = 1/1 ratio, implicit)
- Excludes the tonic (0 cents is implicit in Scala format)

**For Tuning System**:
- All pitch classes from the tuning system
- Cents values relative to starting note (0 cents = 1/1 ratio)
- Octave (1200 cents = 2/1 ratio) as the last entry

**CRITICAL**: Simple maqām/jins exports now use **relative cents from the tonic**, not absolute cents from the tuning system reference. This ensures proper Scala format compliance.

### Algorithm for Maqām/Jins Export

#### Step 1: Get Maqām/Jins Pitch Classes

```typescript
const maqam = maqamData.getTahlil(fullRangeTuningSystemPitchClasses);
const pitchClasses = useAscending ? maqam.ascendingPitchClasses : maqam.descendingPitchClasses;
```

#### Step 2: Calculate Relative Cents from Tonic

```typescript
// Get tonic (first pitch class) cents value
const tonicCents = pitchClasses.length > 0 ? parseFloat(pitchClasses[0].cents) : 0;

// Calculate relative cents for all pitch classes
const scaleNotes = uniquePitchClasses
  .map(pc => ({
    pitchClass: pc,
    relativeCents: parseFloat(pc.cents) - tonicCents
  }))
  .filter(item => Math.abs(item.relativeCents) > 0.01); // Exclude tonic (0 cents)
```

**Important**:
- Tonic cents are subtracted from all pitch classes
- Tonic (0 cents relative) is filtered out as it's implicit in Scala format
- Use `> 0.01` threshold to handle floating point precision

#### Step 3: Check for Octave-Repeating and Add Octave if Needed

```typescript
// Check if the maqam is octave-repeating (has a pitch class at ~1200 cents)
const hasOctave = scaleNotes.some(item => Math.abs(item.relativeCents - 1200) < 5);

// If NOT octave-repeating, add 1200.00 as the octave
if (!hasOctave) {
  scaleNotes.push({
    pitchClass: pitchClasses[0], // Use tonic pitch class as placeholder
    relativeCents: 1200
  });
}
```

**Important**: All simple maqām/jins exports now include the octave (1200 cents). For octave-repeating maqamat, the octave is already present in the pitch classes. For non-octave-repeating maqamat, 1200.00 is automatically added.

#### Step 4: Get Tonic Reference Frequency

```typescript
// Get tonic frequency and note name for header
const tonicPitchClass = pitchClasses[0];
const tonicFrequency = tonicPitchClass ? parseFloat(tonicPitchClass.frequency) : undefined;
const tonicNoteName = tonicPitchClass?.noteName;
```

#### Step 5: Build Header and Export

```typescript
const headerLines = buildScalaHeader(desc, {
  direction: useAscending ? "Ascending" : "Descending",
  rootNote: tonicNoteName,
  tuningSystem: tuningSystem.getTitleEnglish(),
  tonicFrequency: tonicFrequency,
  tonicNoteName: tonicNoteName,
});

const lines = [
  ...headerLines,
  `${desc}`,
  `${scaleNotes.length}`,
  `!`,
  ...scaleNotes.map(item => item.relativeCents.toFixed(2)),
];
```

### Example Output (Maqām Bayyāt)

```
! maqām bayyāt (Ascending) - 7-Fret Oud 17-Tone (Ibn Sīnā, 1037)
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Tonic reference frequency: dūgāh = 293.66 Hz
! Direction: Ascending
! Source tuning system: 7-Fret Oud 17-Tone
!
maqām bayyāt (Ascending) - 7-Fret Oud 17-Tone (Ibn Sīnā, 1037)
7
!
138.57
294.13
498.04
702.00
840.57
996.13
1200.00
```

**Note**:
- 7 entries total (tonic at 0 cents is implicit, 6 pitch classes + octave at 1200.00)
- **New**: Tonic reference frequency line shows the absolute frequency of the tonic note
- **New**: Octave (1200.00) is always included for octave-repeating maqamat

---

### Algorithm for Tuning System Export

#### Step 1: Get Tuning System Pitch Classes

```typescript
const tuningSystem = await TuningSystem.getById(tuningSystemId);
const pitchClasses = getTuningSystemPitchClasses(tuningSystem, startingNote);
```

#### Step 2: Build Header

```typescript
const header = `! ${tuningSystem.stringify()}
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Starting note: ${startingNoteName} (${startingNoteIPN}${startingNoteOctave})
! Starting note frequency: ${startingNoteFrequency} Hz
!
${tuningSystem.getName()} (starting note: ${startingNoteName})
${pitchClasses.length}
!`;
```

**Header Components**:
1. First line: Tuning system description
2. Comment lines starting with `!` for metadata
3. Non-comment line: Tuning system name (displayed in Scala software)
4. Number of entries (excluding implicit 0 cents root)
5. Optional separator comment

#### Step 3: Add Pitch Class Cents Values

```typescript
const entries: string[] = [];

for (let i = 1; i < pitchClasses.length; i++) {
  const pc = pitchClasses[i];
  const cents = parseFloat(pc.cents);
  const centsInOctave = cents % 1200; // Normalize to one octave
  entries.push(centsInOctave.toFixed(2));
}
```

**Important**:
- **Skip the first pitch class** (0 cents / 1/1 ratio is implicit in .scl format)
- **Normalize to one octave**: Use modulo 1200 to get cents within one octave
- **Include octave**: Add 1200.00 as the last entry

#### Step 4: Add Octave and Finalize

```typescript
entries.push('1200.00'); // Octave (2/1 ratio)

const sclContent = header + '\n' + entries.join('\n');
```

### Example Output

```
! al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr)
! Starting note: yegāh (G2)
! Starting note frequency: 97.998 Hz
!
al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone
27
!
90.22
98.95
182.40
203.91
294.13
...
1109.78
1200.00
```

### File Naming

```
{tuningSystemId}_{startingNote}_octave1.scl
```

**Example**: `al-Farabi-(950g)_yegah_octave1.scl`

---

## Section B: 12-Pitch-Class Set .scl Export

### When to Use

Export a maqām's 12-pitch-class set for full chromatic MIDI keyboard mapping.

**Use Cases**:
- MIDI keyboard composition with chromatic note access
- DAW integration for microtonal music production
- Full chromatic transposition capability

### What Gets Exported

- 12 chromatic pitch classes (C, C#, D, D#, E, F, F#, G, G#, A, A#, B)
- Maqām pitch classes + tuning system fillers
- Starting from C (IPN reference), not from maqām tonic
- Suitable for direct .scl import without .kbm file

### Prerequisites

Get the 12-pitch-class set from the API or function:

```typescript
// Option 1: Use API
const response = await fetch(
  `/api/maqamat/classification/12-pitch-class-sets?setId=maqam_rast_set&startSetFromC=true&pitchClassDataType=cents`
);
const data = await response.json();
const pitchClasses = data.sets[0].pitchClassSet.pitchClasses;

// Option 2: Use function directly
const pitchClassSet = create12PitchClassSet(
  maqamTransposition,
  alKindiTuningSystem,
  alKindiStartingNote
);
// Then rotate to start from C (see 12-pitch-class-sets-api.md)
```

**Important**: Always use `startSetFromC=true` when calling the API to get pitch classes starting from C.

### Algorithm

#### Step 1: Get 12-Pitch-Class Set Starting from C

The pitch classes must already be:
- ✅ Rotated to start from C (not maqām tonic)
- ✅ In chromatic ascending order (C, C#, D, ..., B)
- ✅ With octave-shifted values for notes before tonic

**Do NOT re-sort or re-order** - the API/function already provides correct ordering.

#### Step 2: Build Comprehensive Header

The header is generated by the `buildScalaHeader()` function with comprehensive metadata:

```typescript
const headerLines = buildScalaHeader(maqamData.getName(), {
  sourceMaqam: sourceMaqamName,
  tuningSystem: `${tuningSystem.stringify()} + ${alKindiTuningSystem.stringify()}`,
  tuningSystemStartingNote: actualStartingNoteName,
  tuningSystemStartingNoteRefFreq: startingNoteRefFreq,
  referenceFrequency: referenceFrequency,                    // C pitch class frequency
  referenceFrequencyNoteName: referenceFrequencyNoteName,     // e.g., "C3"
  sourceMaqamTonicNoteName: baseMaqamTonicNoteName,           // e.g., "rāst"
  sourceMaqamFrequency: sourceMaqamFrequency,
  sourceMaqamIpnWithOctave: sourceMaqamIpnWithOctave,         // e.g., "C3"
  a4Frequency: a4Frequency,                                    // Natural A4 ~440 Hz
  a4NoteName: a4NoteName,                                      // e.g., "jawāb yegāh"
  exportedMaqamName: maqamData.getName(),
  exportedMaqamFrequency: exportedMaqamFrequency,
  exportedMaqamIpnWithOctave: exportedMaqamIpnWithOctave,
  exportedMaqamTonicNoteName: exportedMaqamTonicNoteName,
  baseUrl: baseUrl,
  url: currentUrl,
  compatibleMaqamat: compatibleMaqamatInfo,
});
```

**Header Structure**:
1. **First line**: `! ${maqamName} (12 pitch class chromatic set)`
2. **Generated by line**: `! Generated by the Digital Arabic Maqām Archive (DiArMaqAr) ${baseUrl}`
3. **Source maqām**: Name and tonic note name
4. **Source tuning system**: Full tuning system description with starting note name and reference frequency
5. **Four frequency reference lines**:
   - Scala file 1/1 (0 cents) reference frequency (C pitch class)
   - Source maqām reference frequency (format: `IPN/noteName = frequency Hz`)
   - A4 reference frequency (natural A4, not microtonal)
   - Exported maqām tonic and frequency
6. **More information URL**
7. **Compatible maqāmāt list**: Grouped by octave equivalents with dual count display

**Header Rules**:
- **Capitalization**: Sentence case for labels. Lowercase for maqām names and note names.
  - ✅ "Source maqām:" (not "Source Maqām:")
  - ✅ "Compatible maqāmāt" (not "Compatible Maqāmāt")
- **Starting Note Name**: Get from `tuningSystem.getNoteNameSets()` using `standardizeText()` comparison
- **A4 Detection**: Find natural A4 using exact match: `pc.englishName === 'A4'` (excludes microtonal variants)
- **Octave Grouping**: Group octave equivalents together, showing transpositions in parentheses
- **Tahlil-First Sorting**: Within groups, non-transposed versions first, then by ascending pitch order
- **Symmetrical Detection**: If ascending == descending (reversed), show single "Sequence" label

#### Step 3: Extract Relative Cents from C

```typescript
const entries: string[] = [];

// First pitch class (C) is at 0 cents (implicit 1/1 ratio)
const referenceCents = parseFloat(pitchClasses[0].cents);

// Add remaining 11 pitch classes
for (let i = 1; i < pitchClasses.length; i++) {
  const pc = pitchClasses[i];
  const cents = parseFloat(pc.cents);
  let relativeCents = cents - referenceCents;

  // Handle wrap-around (should not occur if API used correctly)
  if (relativeCents < 0) {
    relativeCents += 1200;
  }

  entries.push(relativeCents.toFixed(2));
}
```

**Important**:
- First pitch class (C) is at 0 cents relative (implicit 1/1 ratio)
- All other pitch classes are relative to C
- Octave (1200.00) should be the last entry

#### Step 4: Add Octave and Finalize

```typescript
entries.push('1200.00'); // Octave (2/1 ratio)

const sclContent = header + '\n' + entries.join('\n');
```

### Example Output

```
! maqām rāst (12 pitch class chromatic set)
! Generated by the Digital Arabic Maqām Archive (DiArMaqAr) https://diarmaqar.netlify.app
! Source maqām: maqām rāst
! Source maqām tonic note name: rāst
! Source tuning system: al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone + al-Kindī (874) 12-Tone (starting note: yegāh, reference frequency: 98.00 Hz)
! Scala file 1/1 (0 cents) reference frequency: 130.81 Hz (C3)
! Source maqām (maqām rāst) reference frequency: C3/rāst = 130.81 Hz
! A4 reference frequency: A4/jawāb yegāh = 440.00 Hz
! maqām rāst tonic and frequency: C3/rāst = 130.81 Hz
! More information: https://diarmaqar.netlify.app/maqam/rast
!
! Compatible maqāmāt in this set: 38 unique / 127 inc. transpositions:
! - maqām rāst (and its transpositions: maqām rāst al-qarār rāst (C2), maqām rāst al-jawāb rāst (C4))
!   Tonic: C (rāst), position 0
!   Ascending sequence: rāst (C3) → dūgāh (D3) → segāh (E3) → chahārgāh (F3) → nawā (G3) → ḥusaynī (A3) → ʿajam (A#3)
!   Ascending positions: 0 → 2 → 4 → 5 → 7 → 9 → 10
!   Descending sequence: ʿajam (A#3) → ḥusaynī (A3) → nawā (G3) → chahārgāh (F3) → segāh (E3) → dūgāh (D3) → rāst (C3)
!   Descending positions: 10 → 9 → 7 → 5 → 4 → 2 → 0
! - maqām bayyāt (and its transpositions: maqām bayyāt al-qarār dūgāh (D2), maqām bayyāt al-jawāb dūgāh (D4))
!   Tonic: D (dūgāh), position 2
!   Sequence: dūgāh (D3) → segāh (E3) → chahārgāh (F3) → nawā (G3) → ḥusaynī (A3) → ʿajam (A#3) → kurdān (C4)
!   Positions: 2 → 4 → 5 → 7 → 9 → 10 → 0
! ...
maqām rāst - 12-tone chromatic set (al-Fārābī (950g) First Oud Tuning (Full First Octave) 27-Tone + al-Kindī (874) 12-Tone)
12
!
113.69
203.91
294.13
348.73
498.04
611.73
701.96
800.91
905.87
996.09
1109.78
1200.00
```

**Recent Improvements (Dec 2024)**:
- ✅ **Multiple Reference Frequencies**: Header includes 4 frequency lines:
  - Scala file 1/1 (0 cents) reference frequency (C pitch class)
  - Source maqām reference frequency (source maqām tonic)
  - A4 reference frequency (natural A4 ~440 Hz, not microtonal variants)
  - Exported maqām tonic and frequency (actual exported maqām)
- ✅ **Octave Grouping**: Groups octave equivalent maqamat together with transposition lists
- ✅ **Dual Count Display**: Shows "X unique / Y inc. transpositions" format
- ✅ **Tahlil-First Sorting**: Within octave groups, tahlil (non-transposed) versions come first, then sorted by ascending pitch order
- ✅ **Symmetrical Detection**: Automatically detects symmetrical maqamat (ascending == descending reversed) and shows single sequence
- ✅ **Enhanced Pitch Class Formatting**: Persian-Arab-Ottoman name first, then English with octave in brackets (e.g., "dūgāh (D3)")
- ✅ **Relative Cents for Simple Exports**: Maqām/jins exports now use cents relative to tonic (not absolute from tuning system)
- ✅ **Octave Inclusion**: Simple maqām/jins exports always include octave (1200.00) for proper Scala format
- ✅ **Tonic Reference Frequency**: Simple maqām/jins exports now include tonic reference frequency in header

### File Naming

```
{maqamName}_12-tone-chromatic-set_{tuningSystemId}.scl
```

**Example**: `maqam_bayyat_shuri_12-tone-chromatic-set_al-Kindi-(874).scl`

### Function Reference

**`exportMaqamTo12ToneScala()`** in `src/functions/scala-export.ts` (lines 632-1080):

```typescript
export function exportMaqamTo12ToneScala(
  maqamInput: Maqam | MaqamData,
  tuningSystem: TuningSystem,
  startingNote: string,
  alKindiTuningSystem: TuningSystem,
  alKindiStartingNote: string,
  description?: string,
  currentUrl?: string
): string | null
```

**Returns**:
- `.scl` file content as string
- `null` if maqām is not a source for any 12-pitch-class set

---

## .scl File Format Specification

### Structure

```
! Comment line (optional, can have multiple)
Description line (displayed in Scala)
Number of notes
!
cents_value_1
cents_value_2
...
cents_value_N (should be 1200.00 for octave)
```

### Critical Rules

#### 1. Root Note is Implicit
The root note (0 cents / 1/1 ratio) is **NOT included** in the file.

**Correct**: Start with the second pitch class
**Incorrect**: Include 0.00 as first entry

#### 2. Octave Must Be Included
The octave (1200.00 cents / 2/1 ratio) **MUST** be the last entry.

**Correct**: Last line is `1200.00`
**Incorrect**: Last line is the highest note below 1200 cents

#### 3. Entry Count Excludes Root
The number on line 2 (after description) is the count of entries, excluding the implicit root.

**Example**:
```
27-tone tuning
27          ← 27 entries in file (root not counted)
!
90.22       ← Entry 1
...
1200.00     ← Entry 27 (octave)
```

#### 4. Comments Start with !
All comment lines must start with `!` character.

```
! This is a comment
This is not a comment (will be interpreted as description line)
```

#### 5. Cents or Ratios
Pitch values can be expressed as:
- **Cents**: Decimal number (e.g., `203.91`)
- **Ratio**: Fraction (e.g., `9/8`) or decimal ratio (e.g., `1.125`)

DiArMaqAr uses **cents** for consistency and precision.

---

## Common Issues and Solutions

### Issue 1: Wrong Entry Count

**Problem**: Entry count doesn't match number of lines.

**Solution**:
- Count all pitch classes excluding the implicit root (0 cents)
- Include the octave (1200.00) in the count

```typescript
// Correct
const entryCount = pitchClasses.length - 1 + 1; // -1 for root, +1 for octave
// Or simply:
const entryCount = pitchClasses.length;
```

### Issue 2: Missing Octave

**Problem**: Last entry is not 1200.00 cents.

**Solution**: Always add 1200.00 as the final entry.

```typescript
entries.push('1200.00');
```

### Issue 3: Including Root (0 cents)

**Problem**: First entry is 0.00 cents.

**Solution**: Skip the first pitch class (it's implicit).

```typescript
// Correct
for (let i = 1; i < pitchClasses.length; i++) { // Start from index 1

// Incorrect
for (let i = 0; i < pitchClasses.length; i++) { // Includes index 0
```

### Issue 4: Cents Not Normalized to Octave

**Problem**: Cents values exceed 1200 (before octave entry).

**Solution**: Use modulo 1200 to normalize to one octave (for simple tuning system exports).

```typescript
const centsInOctave = cents % 1200;
```

**Note**: For 12-pitch-class sets, do NOT normalize - the API already provides correct values.

### Issue 5: Wrong Starting Note Name

**Problem**: Starting note name is numeric index or incorrect format.

**Solution**: Get starting note name from tuning system's note name sets.

```typescript
// Correct pattern (from API route.ts lines 293-311)
const noteNameSets = tuningSystem.getNoteNameSets();
const matchingSet = noteNameSets.find(set =>
  standardizeText(set[0]) === standardizeText(startingNote)
);
const startingNoteName = matchingSet ? matchingSet[0] : startingNote;

// Incorrect
const startingNoteName = `note_${index}`; // Don't use indices
```

---

## Related Documentation

- [scala-export-overview.md](./scala-export-overview.md) - Choose export type
- [scala-kbm-export.md](./scala-kbm-export.md) - Keyboard mapping files
- [12-pitch-class-sets-api.md](./12-pitch-class-sets-api.md) - API for 12-pitch-class sets
- [12-pitch-class-sets-algorithm.md](./12-pitch-class-sets-algorithm.md) - Algorithm details

## External Resources

- [Official Scala .scl Format Specification](https://www.huygens-fokker.org/scala/scl_format.html)

---

*Complete guide for creating Scala .scl files from DiArMaqAr tuning data*
